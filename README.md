# prologue

The Prologue library provides the authentication, authorization logic
and role checks used by all Drama development, and a number of filters
by default for security. several filters for security by default.
These are automatically applied when you include Prologue library
dependencies, please see [NARA Way](https://naraway.io).

## Features

- Spring OAuth security filter
- Space security filters for workspace
- Access control filter by tenant role
- Filters for exception handling when backend services fail
- Internal token bean for calls between internal services
- JAP and Mongo handling for dynamic queries
- REST call helper implementations with WebFlex

## Installation

```groovy
implementation 'io.naraway:prologue'
```

## Configuration

Prologue has settings that are defined by default and additional
settings that you need to add. Below is a list of You can see the
full list of settings, their default values, and descriptions.

```yaml
nara:
  # You need to set public-key and private-key as JWT Signing key 
  # values. The initial key string can be generated by performing 
  # the JwkTools.main() code.
  jwt-signing:
    key-id: nara
    # Initialization required (must be the same as the value set for 
    # checkpoint)
    public-key: |
      -----BEGIN RSA PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1YLuF25/iPsNgioEa2Ls
      f7iQv35myj4lsa6zQQwxuj7qoLF4d6m9uU07fTiQQf8rPKlE+hM6oj8J/KlEue5T
      tv747dagnff7xSt76NOxkgYCgo4rf9mFUI7TyyjREex8A2c9uLcYAdrRXhTnQqqN
      mYB6cdyS8dV02vgE8Vuf3BJizQxk9ssvatzeJtvJnh2NrLFVix/JikhGM36HpHHu
      qtSZh01TXarM92/t70QyL1hdUOdDT4mfTKO/wzCdlLdSCBufomrAbvk88jTa2fCr
      qsGrIT5mi3uPtpUKdqRDlCxLzcmWXgFRB5OCI464YCwzWGwfTIJ/h32z+rrMBEpu
      +wIDAQAB
      -----END RSA PUBLIC KEY-----
    # Initialization required (must be the same as the value set for 
    # checkpoint)
    private-key: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDVgu4Xbn+I+w2C
      KgRrYux/uJC/fmbKPiWxrrNBDDG6PuqgsXh3qb25TTt9OJBB/ys8qUT6EzqiPwn8
      qUS57lO2/vjt1qCd9/vFK3vo07GSBgKCjit/2YVQjtPLKNER7HwDZz24txgB2tFe
      FOdCqo2ZgHpx3JLx1XTa+ATxW5/cEmLNDGT2yy9q3N4m28meHY2ssVWLH8mKSEYz
      foekce6q1JmHTVNdqsz3b+3vRDIvWF1Q50NPiZ9Mo7/DMJ2Ut1IIG5+iasBu+Tzy
      NNrZ8KuqwashPmaLe4+2lQp2pEOULEvNyZZeAVEHk4IjjrhgLDNYbB9Mgn+HfbP6
      uswESm77AgMBAAECggEALr03NqzrQUbH+b8N8Z4ZrInwMeNPSCWbpc5bEjnDpwQ/
      44aGGxfu3uIfzDU2KyRbSC+72EyeUMcg/gzl7RfVfqFJR/NsfLg9BrgSq3CwFgm3
      wfGyZw3sh6qEhZw9TEGrEimnEskN+dX3cDN+PpNMZRaBd2x0RHlYV9jkaBuJHqkH
      P6htXGOslulWCJAF3hYPjjxOQjgFoInt3RLDBkuRl1HOPPhCn2umlhBRv+UVo/uG
      KKggbOo/eYQgkhENY9TeK0f3j7JdIaVacmSJv8UijBciP1By9Ca0WjTrBJP8Rm8b
      aCcehj2bks4rqXanOSgMGBPkMgJdmugiaS3onYlMbQKBgQD0Smms8+vppzNSbtlx
      RXjnwv+uaSLneaBC0NNie+OrYGQQDFeedTAWXi2vG7AsXiGgjwF9S0TbMC+yh+75
      Y/Q5QfFVDdmH7uedwsgdncgo9ZRHN/SlEDEpMFfcHt4DfjX68+pvX8cFHK/R3XiC
      gDNBNZeAUqmtKzH6hgYYvXyJvwKBgQDfvtagemiy816nuhP8NyIdvUzlesHQIXSb
      L1Z7cUJ9clT1PqNPXPp6Cn1ySzwPSo87hLtdl6hWhF3RARdqBVfGCZGaNyw3pwpi
      Z2kq+HW767Sf3kiiwJgcgjyx+ooAn/GN5mFCXAXSCP82sNecL/HbdoK2OoNGcv+E
      Ad1YBeFRxQKBgQDf6oE4hZA86AQT0AVBXSN4k/VWQYo7z/EErXLEd7h0cnLlftql
      JNdB+Ws4cVGnKVT7XXlJBkAEBQQDSbPTJjpKbVYu1vYIMgRdR5e0BdbdLFSQfwqg
      bdoR3fz6h9SKMRp7fy3ojkrXNbc2zyDRxX61i9DlT1+1mb1C26wk6zKG8wKBgQCx
      en5jA1YjhLqzjv2lVdJhBrSFXw932eHV6wHNnzSfr15Gvq3qGRWyUrnZPGZitsDQ
      9GNvRQpJvmtwi04YUi6irxpo2pTffEfXcLHSXQ1+x+QZ38d8GgtOqdwdTV/ESRrh
      dTn22mnfhjVzG2mbwcg2TlY22EkjS7r06km6NcfaBQKBgAwPPnzS6Cjic7cVMbtu
      WsgpjvaTC0Gh/nlhOvR5ZH5No+rQ6ouW9BQzBElkYF3G1zl2O84n74tQjaK65lFR
      QTaKL0+cO51CP6RWBgKu+KYt1VP+m3F/d3CrXN9UQEbD7Hc+BTMoiXDk1qcdeeCF
      g0swhbBUZ34ke0nBF16Gz4Xj
      -----END RSA PRIVATE KEY-----

  prologue:
    # Whether to enable Prologue; if false, it will not ride on filters
    # such as authentication/authorization; set to false for local 
    # development.
    enabled: true,

    # Stub data that will be used as the default context if prologue. 
    # enabled is false.
    default-context:
      username: nara@naraway.io
      user-type: citizen
      display-name: NARA Way
      email: nara@naraway.io
      enabled: true
      actor-id: 1@1:1:1:1-1
      pavilion-id: 1:1:1
      osid: nextree
      usid: nara
      kollection-id: nara
      cineroom-ids: 1:1:1:1, 1:1:1:2
      roles: manager, user
      attributes:

    # Sets the URLs not to authenticate. This is added to the items set 
    # by default.
    permit-all-ant-matchers: # Not specified

    # This setting is for getting the Internal Token value to be used 
    # between back services.
    internal-auth:
      enabled: true
      refresh-interval-seconds: 900 # 15 Minutes
      username: drama # It is automatically set to the spring application name
      password: my-internal-secret # Whatever else
      client:
        id: nara
        secret: my-secret # Whatever else
      rest:
        base-url: http://checkpoint:8080
        loopback: false
        base-method: POST
        retry: 3
        request-timeout-seconds: 5
        max-memory-size: 1048576

    # Retrieve Actor's dock information from back service metro on every 
    # Erequest. Cache it for a period of time.
    dock:
      enabled: true
      cache-type: ehcache
      cache-ttl-seconds: 1800 # 30 Minutes
      cache-refresh-interval-seconds: 900 # 15 Minutes
      rest:
        base-url: http://metro:8080
        loopback: false
        base-method: POST
        retry: 3
        request-timeout-seconds: 5
        max-memory-size: 1048576

    # Set the XSS security filter. By default, it escapes HTML for regular form
    # requests and only tags for JSON/XML requests.
    xss-secure:
      enabled: true
      exclude-urls: # Not specifiedqwrf ffbq  wqr4
      converter: escape

    # Set a filter to restrict the use of HTTP methods.
    method-secure:
      enabled: true,
      methods: OPTIONS, TRACE, COPY, CONNECT
```

## Usage

### DynamicQuery

Provides helper classes for JPA and mongo for making simple dynamic queries.
These are `MongoDynamicQuery` and `JpaDynamicQuery`, respectively. They take
`QueryParams` and a `MongoTemplate` or `EntityManager` and support casting and
paging.

```java
public class FooFlow {
    //
    public List<FooDoc> findFooDocs(String name, int age) {
        //
        MongoTemplate mongoTemplate = null;
        QueryParams queryParams = QueryParams.dynamic(
                QueryParam.and("name", Operator.Equal, name),
                QueryParam.and("age", Operator.LessThan, age));

        return new MongoDynamicQuery<FooDoc>(mongoTemplate, queryParams, FooDoc.class).findAll();
    }
}
```

### RestRequester

RestRequester provides a waapper functionality for WebClient to handle REST
calls between national backend services. Calls between services can be made
using an internal token, which is an internal authentication, or with a
header consumer object that passes the HTTP header values of the initial
requesting backend service from the front end as is. Alternatively, it can
be created without any headers and used to call external non-NARA services.

```java
@RequiredArgsConstructor
public class ProductProxy {
    //
    private final InternalAuthProvider internalAuthProvider;
    private final RestRequesterProperties restProps;

    private RestRequester rest;

    @PostConstruct
    private void initialize() {
        //
        this.rest = new RestRequester(this.restProps, this.internalAuthProvider);
    }

    public Product findServerProducts(String productId) {
        //
        String path = UriComponentsBuilder
                .fromUriString("/restful/products/{product-id}")
                .buildAndExpand(productId)
                .toUriString();

        return this.rest.get(path, Product.class).block();
    }

    // ...
}
```

### JwtSupport Bean

This helper bean reads the JWT value passed in the user's REST request,
validates it with the server's signing information, and extracts the value
inside the token as a claim. It comes in a Spring context, so you can use
it to read the JWT value directly.

```java
@RequiredArgsConstructor
public class ProductProxy {
    //
    private final JwtSupport jwtSupport;

    // ...

    private Map<String, Object> getClaims(String token) {
        //
        return jwtSupport.getClaims(token);
    }

    // ...
}
```

## Getting more help

Visit the Nara Way page to get more information about the library:  
[https://github.com/naraway](https://github.com/naraway)

You can ask any question about Nara Way using the [NARA Way Page](https://www.naraway.io).
